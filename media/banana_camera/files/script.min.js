var imgFrameWidth = $(window).width();
var imgFrameHeight = $(window).width();

var Banana = function() {
    function g() {
        if($("#filterBox").size() > 0){
            var a = $("#filterBox .swiper-container").swiper({
                //visibilityFullFit: !0,
                //slidesPerView: "auto"
                visibilityFullFit: true,
                slidesPerView: 1,
                centeredSlides: true,
                spaceBetween: 10
            });
        }
        else{
            var a = $(".swiper-container").swiper({
                visibilityFullFit: true,
                slidesPerView: 1,
                centeredSlides: true,
                spaceBetween: 10
            });
        }

        $("#filterBox .arrow-left").on("click", function() {
            a.swipePrev()
        });
        $("#filterBox .arrow-right").on("click", function() {
            a.swipeNext()
        });
        var c = $("#frameBox .swiper-container").swiper({
            visibilityFullFit: !0,
            slidesPerView: "auto"
        });
        $("#frameBox .arrow-left").on("click", function() {
            c.swipePrev()
        });
        $("#frameBox .arrow-right").on("click", function() {
            c.swipeNext()
        });

        /* -- temp --*/
        /*
        var sa = $("#stickerBox .swiper-container").swiper({
            visibilityFullFit: !0,
            slidesPerView: "auto"
        });
        $(".arrow-left").on("click", function() {
            sa.swipePrev()
        });
        $(".arrow-right").on("click", function() {
            sa.swipeNext()
        });
        */
        /* -- end temp -- */
        
        var isMobile = false; //initiate as false
        // device detection
        if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
            || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) isMobile = true;


        if(isMobile){
            /*
            var sa = $("#stickerBox .swiper-container").swiper({
                visibilityFullFit: !0,
                slidesPerView: "auto"
            });
            $("#stickerBox .arrow-right").on("touchstart mousedown", function(a) {
                sa.swipeNext();
            });
            $("#stickerBox .arrow-left").on("touchstart mousedown", function(a) {
                sa.swipePrev();
            });
            */
        }
        else{
            var h = new Swiper("#stickerBox .swiper-container", {
                onlyExternal: !0,
                speed: 500
            });

            $("#stickerBox .tabs a").on("touchstart mousedown", function(a) {
                $("#stickerBox .tabs .active").removeClass("active");
                $(this).addClass("active");
                h.swipeTo($(this).index())
            });
        }
    }

    function k() {
        $("#imgBox").on("drop", function(a) {
            a.stopPropagation();
            a.preventDefault();
            a.originalEvent.dataTransfer && a.originalEvent.dataTransfer.files.length && d(a.originalEvent.dataTransfer.files[0])
        });
        $("#imgBox").on("dragover dragenter dragleave", function(a) {
            a.stopPropagation();
            a.preventDefault()
        })
    }

    // 有圖片上傳時會啟動
    function d(a) {
        if ("image/png" != a.type && "image/jpeg" != a.type){
            alert("\u53ea\u80fd\u4e0a\u50b3 png \u6216 jpg \u6a94\u6848");
            if(typeof($.unblockUI) !== 'undefined'){
                $.unblockUI();
            }
        }
        else {
            var c = new FileReader;
            c.onload = function(a) {
                console.log('in d(): ' + a);
                //console.log('in d(): ' + a.height);
                l(a.target.result)
            };
            c.readAsDataURL(a)
        }
    }

    function rotateBase64Image(base64data) {
        var canvas = document.getElementById("thecanvas");
        var ctx = canvas.getContext("2d");
        var img = new Image();
        
        img.onload = function() {
            ctx.translate(img.width, img.height);
            ctx.rotate(180 * Math.PI / 180);
            ctx.drawImage(img, 0, 0);
            uploadImg.src = canvas.toDataURL();
            //window.eval(""+callback+"('"+canvas.toDataURL()+"')");
        };
        img.src = base64data;
    }

    // very important, 接續d() 函式, 從 m() 函式指定的 event handler 觸發（當有圖片上傳時）
    function l(a) {
        //alert(a);
        BananaFrame.clearFrame();
        BananaFilter.clearFilter();
        BananaSticker.clearSticker();
        $("#frame").remove();
        $("#uploadImg").removeAttr("style");
        $("#imgBox > .view").removeAttr("style"); 

        //console.log('in l(): ' + a);
        //console.log('in l(): ' + a.height);

        if(typeof(getMobileOperatingSystem) !== 'undefined'){
            var os_type = getMobileOperatingSystem();
            if(os_type == 'Android' || os_type == 'unknown'){
                $("#uploadImg").attr("src", a);
                setTimeout('Banana.manipulateThumb();', 3000);
                return;
            }
        }

        var i = new Image(); 
        // for iOS(原始拍照出的檔案會自動逆時針轉90度，需要校正)
        i.onload = function(){
            //alert(window.orientation);
            alert( i.width+", "+i.height );
            // 手機直式
            
            if(window.orientation == 0){
                //adjustByWidth(i.width,i.height);
                adjustByHeight(i.width, i.height);
            }
            // 手機橫式
            else{
                adjustByHeight(i.width, i.height);
            }
            
            $('#uploadImg').rotate({
                animateTo:90,
                callback: function(){
                    $.unblockUI();
                    $("#uploadImg").on("load", function(){
                        $("#uploadImg").off("load");
                        setTimeout('Banana.outer_f();', 2000);
                        //f();
                    });
                    $("#uploadImg").attr('src', a);
                }
            });
        };

        i.src = a;
        /*
        // first bind one event handler(trigger when image load)
        $("#uploadImg").on("load", function() {
            $("#uploadImg").off("load");
            var a = $("#uploadImg").width(),
                b = $("#uploadImg").height(),
                e = $("#imgBox").width(),
                //d = $("#imgBox").width();
                d = $("#imgBox").height();

                console.log('in l()-2: ' + $("#uploadImg").width());
                console.log('in l()-2: ' + $("#uploadImg").height());

            //alert($('#uploadImg').getRotateAngle());

                //console.log('width: ' + a);


            // if a/b > 1 --> width of uploadImg is greater than height of uploadImg
/*
            a / b > e / d ? $("#uploadImg").css({
                width: e
            }) : ($("#uploadImg").css({
                height: d
            }), a = $("#uploadImg").width(), $("#imgBox > .view").css({
                width: a,
                "margin-left": (e - a) / 2
            }));


            // width > height
            if(a > b){
                result = adjustByHeight(a,b);
            }
            else{
                adjustByWidth(a,b);
            }


            f();
        });
*/
    
        //alert(a);
        // then assign src of this image, which will cause load effect, then trigger the 'load' handler
        //$("#uploadImg").attr("src", a);
    }

    function adjustByWidth(width, height){
        var w_zoom_ratio = imgFrameWidth / width;
        //var h_zoom_ratio = b / imgFrameHeight;
        var new_h = height * w_zoom_ratio;
        $("#uploadImg").width(imgFrameWidth);
        $("#uploadImg").height(new_h);
        $("#uploadImg").css({'margin-top': (imgFrameHeight - new_h)/2});
        return {'width': imgFrameWidth, 'height': new_h};
    }

    function adjustByHeight(width, height){
        var h_zoom_ratio = imgFrameHeight / height;
        var new_w = width * h_zoom_ratio;
        $("#uploadImg").width(new_w);
        $("#uploadImg").height(imgFrameHeight);
        $("#uploadImg").css({'margin-left': (imgFrameWidth - new_w)/2});
        return {'width': new_w, 'height': imgFrameHeight};
    }

    // 
    function f() {
        $("#uploadImg").off("load");
        b = $("body").scrollTop();
        html2canvas($("#imgBox>.view")[0], {
            onrendered: function(a) {
                /*
                $.unblockUI();
                console.log(a.width);
                console.log(a.height);
                document.body.appendChild(a);
                return;
                */
                //alert(a);

                $("#uploadImgBackUp").html("");
                $("#uploadImgBackUp").append(a);
                //$("#uploadImg").off("load");
                $("#uploadImg").attr("src", a.toDataURL("image/png"));

                if(auto_add_frame == true){
                    var uploadImg_w = $("#uploadImg").width();
                    var uploadImg_h = $("#uploadImg").height();
                    var frame = $('<img id="frame" src="/media/banana_camera/img/webview_frame-1.png" style="position: absolute">');
                    //frame.width(uploadImg_w);
                    //frame.height(uploadImg_h);
                    frame.width(imgFrameWidth);
                    frame.height(imgFrameHeight);
                    $(".stickerBox").append(frame);

                    // canvas繪製完畢，原本用以修正 html 排版的樣式設定不再需要 --> 歸零補正
                    //if(uploadImg_w > uploadImg_h){
                        $("#uploadImg").css({'width': 'auto', 'margin-left': '0px'});
                    //}else{
                        $("#uploadImg").css({'height': 'auto', 'margin-top': '0px'});
                    //}
                    $('#uploadImg').rotate({animateTo:0, duration: 0});
                }
                
                if(typeof($.unblockUI) !== 'undefined'){
                    $.unblockUI();
                }

                $("body").scrollTop(b)
            }//,
            //width: imgFrameWidth,
            //height: imgFrameHeight
        });
    }

    function m() {
        $("#btnCreate").on("click",
            function() {
                createDownload()
            });
        $("#inputUpload").on("change", function() {
            if(typeof($.unblockUI) !== 'undefined'){
                $.blockUI({
                    message: '<img width="90%" src="/media/banana_camera/files/ajax-loader.gif?v={{version}}" />',
                    css: {backgroundColor: 'transparent', border: 'none'}
                });
            }
            $("#inputUpload")[0].files.length && d($("#inputUpload")[0].files[0])
        });
        $("#btnDownload").on("click", function(a) {
            if(typeof($.unblockUI) !== 'undefined'){
                $.blockUI({
                    message: '<img width="90%" src="/media/banana_camera/files/ajax-loader.gif?v={{version}}" />',
                    css: {backgroundColor: 'transparent', border: 'none'}
                });
            }
            // line play event
            if(typeof(Cookie) !== 'undefined'){
                if(Cookie.read('line-play') == null){
                    var redirect_url = {
                        //'iOS': 'https://itunes.apple.com/tw/app/line-play-da-zao-wan-mei-xiao-wu/id575147772?l=zh&mt=8',
                        //'Android': 'https://play.google.com/store/apps/details?id=jp.naver.lineplay.android&hl=zh_TW',
                        //'unknown': 'https://play.google.com/store/apps/details?id=jp.naver.lineplay.android&hl=zh_TW'
                        'iOS': 'http://lin.ee/fGqVEPn/lply/ro',
                        'Android': 'http://lin.ee/fGqVEPn/lply/ro',
                        'unknown': 'http://lin.ee/fGqVEPn/lply/ro'
                    }

                    Cookie.create('line-play', 'visited');
                    var confirmResult = confirm("您是第一次使用，建議可以免費下載 LINE PLAY 拜訪香蕉人的房間喔!");
                    if (confirmResult == true) {
                        var os_type = getMobileOperatingSystem();
                        $.unblockUI();
                        window.open(redirect_url[os_type]);
                    }
                }
            }
            n();
            a.preventDefault();
        })
    }

    function n() {
        BananaSticker.blurAll();
        b = $("body").scrollTop();
        html2canvas($("#imgBox>.view")[0], {
            onrendered: function(a) {
                a.toBlob(function(a) {
                    //console.log(a);
                    //saveAs(a, "pretty image.png");

                    //console.log(a.size);
                    //alert(a.size);
                    //console.log(a.type);
                    //alert(a.type);

                    //window.URL = window.URL || window.webkitURL;

                    //var objectURL = window.URL.createObjectURL(a);
                    //console.log(objectURL);
                    //alert(objectURL);

                    //window.open(objectURL);

                    //location.href = objectURL;

                    var reader = new FileReader();
                    var out = new Blob([a], {type: 'image/jpeg', quality: 0.95});
                    reader.onload = function(e){
                      var bdata = btoa(reader.result);
                      var datauri = 'data:image/jpeg;base64,' + bdata;
                      //alert(datauri);
                      window.location.href = datauri;
                    }
                    reader.readAsBinaryString(out);


                    //$("body").append("<img src='"+objectURL+"' />");
                    //$("body").append("<img src='http://imgapi.nownews.com/?w=800&q=80&src=http%3A%2F%2Fs.nownews.com%2F2a%2Ff8%2F2af8163b513a3168fc84833ff1417c7a.jpg' />");

                    //var image = document.createElement('img');
                    //image.src = objectURL;
                    //document.body.appendChild(image);

                    //var image1 = document.createElement('img');
                    //image1.src = '';
                    //document.body.appendChild(image1);
                    //saveAs(a, "BananaCamera.png")
                }, "image/jpeg", 1.0);
                //}, );
                $("body").scrollTop(b)
            }
        })
    }
    var b = 0;
    return {
        rotate: function(){
            var base64data = uploadImg.src;
            rotateBase64Image(base64data);
        },
        outer_f: function(){
            f();
        },
        manipulateThumb: function(){
            var a = $("#uploadImg").width(),
                b = $("#uploadImg").height(),
                e = $("#imgBox").width(),
                //d = $("#imgBox").width();
                d = $("#imgBox").height();

            //alert('width: ' + a);
            //alert('height: ' + b);
            if(a > b){
                result = adjustByHeight(a,b);
            }
            else{
                adjustByWidth(a,b);
            }

            f();
        },
        init: function() {
            g();
            k();
            m();
            // convert from html to canvas data
            setTimeout("Banana.outer_f();", 3000);
        }
    }
}();